{% extends "shared/base.html" %}

{% block title %}Admin Dashboard - DDM Racing System{% endblock %}

{% block body_class %}admin-dashboard{% endblock %}

{% block header_title %}DDM Racing System{% endblock %}
{% block header_subtitle %}Admin Dashboard - Voice-Activated LED Control{% endblock %}

{% block extra_css %}
<style>
/* Admin-specific styles */
.admin-dashboard {
    background: var(--primary-gradient);
}

.feature-card {
    text-align: center;
    padding: var(--spacing-xl);
    transition: var(--transition-base);
    cursor: pointer;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.feature-card:hover {
    transform: translateY(-5px);
}

.mode-card {
    cursor: pointer;
    transition: var(--transition-base);
}

.mode-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-xl);
}

.feature-icon {
    font-size: 3rem;
    margin-bottom: var(--spacing-lg);
}

.animation-btn {
    margin: var(--spacing-sm);
    min-width: 150px;
}

/* During Race Modal Special Styling */
.during-race-modal .modal-content {
    border: 3px solid #28a745;
    box-shadow: 0 0 20px rgba(40, 167, 69, 0.4);
}

.during-race-modal .modal-header {
    background: var(--success-gradient);
    animation: pulse-green 2s ease-in-out infinite;
}

.during-race-modal .animation-btn {
    font-size: var(--font-size-lg);
    padding: var(--spacing-lg) var(--spacing-xl);
    margin: var(--spacing-md);
    min-width: 200px;
    font-weight: bold;
}

.during-race-modal .animation-btn:first-child {
    background: var(--success-gradient);
    color: var(--white);
    border: none;
}

.during-race-modal .animation-btn:nth-child(2) {
    background: var(--warning-gradient);
    color: var(--white);
    border: none;
}

.during-race-modal .animation-btn:last-child {
    background: var(--danger-gradient);
    color: var(--white);
    border: none;
}

@keyframes pulse-green {
    0% { box-shadow: 0 0 20px rgba(40, 167, 69, 0.4); }
    50% { box-shadow: 0 0 30px rgba(40, 167, 69, 0.8); }
    100% { box-shadow: 0 0 20px rgba(40, 167, 69, 0.4); }
}

/* Background animation mirroring */
.bg-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: var(--z-behind);
    opacity: 0.1;
    transition: var(--transition-slow);
}

.bg-animation.theyre-off {
    background: radial-gradient(circle at center, #28a745 0%, #20c997 50%, #17a2b8 100%);
    animation: racing-pulse 0.5s ease-in-out infinite;
}

.bg-animation.down-the-stretch {
    background: linear-gradient(45deg, #ffc107, #fd7e14, #dc3545, #6f42c1);
    animation: intensity-wave 1s ease-in-out infinite;
}

.bg-animation.finish-race {
    background: repeating-linear-gradient(
        45deg,
        #000 0px,
        #000 20px,
        #fff 20px,
        #fff 40px
    );
    animation: checkered-flag 2s linear infinite;
}

.bg-animation.race-results {
    background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700, #ffed4e);
    animation: victory-celebration 3s ease-in-out infinite;
}

@keyframes victory-celebration {
    0% { 
        background-position: 0% 0%;
        opacity: 0.1;
    }
    50% { 
        background-position: 100% 100%;
        opacity: 0.2;
    }
    100% { 
        background-position: 0% 0%;
        opacity: 0.1;
    }
}

@keyframes racing-pulse {
    0% { transform: scale(1); opacity: 0.1; }
    50% { transform: scale(1.05); opacity: 0.2; }
    100% { transform: scale(1); opacity: 0.1; }
}

@keyframes intensity-wave {
    0% { filter: hue-rotate(0deg); }
    50% { filter: hue-rotate(180deg); }
    100% { filter: hue-rotate(360deg); }
}

@keyframes checkered-flag {
    0% { background-position: 0 0; }
    100% { background-position: 40px 40px; }
}

/* Horse Selection Modal Styles */
.horse-selection-modal .modal-content {
    border: 4px solid var(--gold-light);
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
}

.horse-selection-modal .modal-header {
    background: linear-gradient(135deg, var(--gold-light) 0%, #ffed4e 100%);
    color: var(--gray-800);
    text-align: center;
}

.horse-selection-modal .modal-title {
    font-size: var(--font-size-xxxl);
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.result-number.reveal {
    animation: pixelate-in 1.5s ease-out forwards;
}

.win-box.selected {
    background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 50%, var(--gold-dark) 100%);
    animation: gold-pulse 2s ease-in-out infinite;
    border-color: var(--gold-light);
}

.place-box.selected {
    background: linear-gradient(135deg, var(--silver) 0%, var(--silver-light) 50%, var(--silver-dark) 100%);
    animation: silver-pulse 2s ease-in-out infinite;
    border-color: var(--silver-light);
}

.show-box.selected {
    background: linear-gradient(135deg, var(--bronze) 0%, var(--bronze-light) 50%, var(--bronze-dark) 100%);
    animation: bronze-pulse 2s ease-in-out infinite;
    border-color: var(--bronze-light);
}

@keyframes gold-pulse {
    0% { 
        box-shadow: 0 0 20px rgba(218, 165, 32, 0.6); 
        transform: scale(1.05);
    }
    50% { 
        box-shadow: 0 0 40px rgba(255, 215, 0, 0.9); 
        transform: scale(1.08);
    }
    100% { 
        box-shadow: 0 0 20px rgba(218, 165, 32, 0.6); 
        transform: scale(1.05);
    }
}

@keyframes silver-pulse {
    0% { 
        box-shadow: 0 0 20px rgba(168, 168, 168, 0.6); 
        transform: scale(1.05);
    }
    50% { 
        box-shadow: 0 0 40px rgba(211, 211, 211, 0.9); 
        transform: scale(1.08);
    }
    100% { 
        box-shadow: 0 0 20px rgba(168, 168, 168, 0.6); 
        transform: scale(1.05);
    }
}

@keyframes bronze-pulse {
    0% { 
        box-shadow: 0 0 20px rgba(184, 134, 11, 0.6); 
        transform: scale(1.05);
    }
    50% { 
        box-shadow: 0 0 40px rgba(205, 133, 63, 0.9); 
        transform: scale(1.08);
    }
    100% { 
        box-shadow: 0 0 20px rgba(184, 134, 11, 0.6); 
        transform: scale(1.05);
    }
}

@keyframes pixelate-in {
    0% { 
        opacity: 0;
        transform: scale(0.1);
        filter: blur(10px);
    }
    25% { 
        opacity: 0.3;
        transform: scale(0.5);
        filter: blur(8px);
    }
    50% { 
        opacity: 0.6;
        transform: scale(0.8);
        filter: blur(4px);
    }
    75% { 
        opacity: 0.9;
        transform: scale(1.1);
        filter: blur(1px);
    }
    100% { 
        opacity: 1;
        transform: scale(1);
        filter: blur(0);
    }
}

#modal-end-race-btn {
    display: none;
}

/* Responsive adjustments for admin dashboard */
@media (max-width: 767px) {
    .feature-card {
        padding: var(--spacing-lg);
        min-height: 120px;
    }
    
    .feature-icon {
        font-size: 2.5rem;
    }
    
    .animation-btn {
        min-width: 120px;
        margin: var(--spacing-xs);
    }
}

@media (max-width: 575px) {
    .feature-card {
        padding: var(--spacing-md);
        min-height: 100px;
    }
    
    .feature-icon {
        font-size: 2rem;
    }
    
    .horse-selection-modal .modal-title {
        font-size: var(--font-size-xl);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- UI Mode Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-white mb-4">üéÆ Racing Mode Control</h2>
        </div>
        
        <!-- Pre-Race Mode -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card feature-card mode-card" onclick="openModeModal('pre_race')">
                <div class="feature-icon">üèÅ</div>
                <h4>Pre-Race</h4>
            </div>
        </div>
        
        <!-- Betting Open Mode -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card feature-card mode-card" onclick="openModeModal('betting_open')">
                <div class="feature-icon">üí∞</div>
                <h4>Betting Open</h4>
            </div>
        </div>
        
        <!-- During Race Mode -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card feature-card mode-card" onclick="openModeModal('during_race')">
                <div class="feature-icon">üèá</div>
                <h4>During Race</h4>
            </div>
        </div>
        
        <!-- Results Mode -->
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card feature-card mode-card" onclick="openModeModal('results')">
                <div class="feature-icon">üèÜ</div>
                <h4>Results</h4>
            </div>
        </div>
    </div>
    
    <!-- Voice & Manual Control (Collapsed) -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <button class="btn btn-link text-white" type="button" data-bs-toggle="collapse" data-bs-target="#voiceControls">
                            üé§ Voice & Manual Controls
                        </button>
                    </h5>
                </div>
                <div id="voiceControls" class="collapse">
                    <div class="card-body">
                        <div class="row">
                            <!-- Voice Control -->
                            <div class="col-lg-6 col-md-12">
                                <div class="text-center">
                                    <div class="feature-icon">üé§</div>
                                    <h5>Voice Animation Control</h5>
                                    <p class="text-muted">Speak your LED animation ideas and watch them come to life!</p>
                                    <button class="btn btn-primary btn-lg" onclick="voicePrompt.startListening()">
                                        üé§ Start Voice Prompt
                                    </button>
                                    <p class="small text-muted mt-2">
                                        <span id="voice-support-status">Checking voice support...</span>
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Manual Control -->
                            <div class="col-lg-6 col-md-12">
                                <div class="text-center">
                                    <div class="feature-icon">‚å®Ô∏è</div>
                                    <h5>Manual Animation Control</h5>
                                    <p class="text-muted">Type your animation description for precise control.</p>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="manualPrompt" placeholder="e.g., red lightning storm" maxlength="100">
                                        <button class="btn btn-primary" onclick="sendManualPrompt()">
                                            ‚ú® Generate
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Status & Controls -->
    <div class="row">
        <!-- System Status -->
        <div class="col-lg-4 col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üîß System Status</h5>
                    <div class="mb-2">
                        <span class="status-indicator status-online"></span>
                        Flask Server: Online
                    </div>
                    <div class="mb-2">
                        <span class="status-indicator" id="openai-status"></span>
                        OpenAI Integration: <span id="openai-text">Checking...</span>
                    </div>
                    <div class="mb-2">
                        <span class="status-indicator status-offline"></span>
                        ESP32 Devices: 0 Found
                    </div>
                </div>
            </div>
        </div>
        
        <!-- OpenAI Usage -->
        <div class="col-lg-4 col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üìä AI Usage</h5>
                    <div class="mb-2">
                        <strong>Hourly:</strong> <span id="hourly-usage">0/50</span>
                    </div>
                    <div class="mb-2">
                        <strong>Daily:</strong> <span id="daily-usage">0/200</span>
                    </div>
                    <div class="form-check form-switch mt-3">
                        <input class="form-check-input" type="checkbox" id="openaiToggle" checked>
                        <label class="form-check-label" for="openaiToggle">
                            Enable OpenAI
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="col-lg-4 col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">‚ö° Quick Actions</h5>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="testAnimation()">
                            üß™ Test Animation
                        </button>
                        <button class="btn btn-outline-success" onclick="refreshStatus()">
                            üîÑ Refresh Status
                        </button>
                        <button class="btn btn-outline-warning" onclick="clearLogs()">
                            üßπ Clear Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Animation History -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">üé® Recent Animations</h5>
                    <div id="animation-history">
                        <p class="text-muted">No animations generated yet. Try the voice prompt above!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Voice Button -->
<button class="voice-trigger-btn" onclick="voicePrompt.startListening()" title="Voice Prompt">
    üé§
</button>
{% endblock %}

{% block modals %}
<!-- Animation Mode Modal -->
<div class="modal fade" id="animationModal" tabindex="-1" aria-labelledby="animationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content h-100">
            <div class="modal-header">
                <h5 class="modal-title" id="animationModalLabel">
                    <span id="modal-mode-icon">üèÅ</span>
                    <span id="modal-mode-title">Pre-Race Animations</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Select an animation to run for this mode:</p>
                <div id="animation-buttons" class="text-center">
                    <!-- Animation buttons will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modal-cancel-btn">Cancel</button>
                <button type="button" class="btn btn-danger" id="modal-end-race-btn" onclick="endRace()">
                    üèÅ End Race
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Horse Selection Modal (Results Mode) -->
<div class="modal fade" id="horseSelectionModal" tabindex="-1" aria-labelledby="horseSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content horse-selection-modal">
            <div class="modal-header">
                <h3 class="modal-title" id="horseSelectionModalLabel">
                    üèÜ <span id="selection-step">SELECT WINNING HORSE</span>
                </h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body h-100 d-flex flex-column">
                <div class="row flex-grow-1" style="min-height: 500px;">
                    <!-- Horse Number Grid - LEFT SIDE -->
                    <div class="col-12 col-lg-9 d-flex flex-column h-100">
                        <div class="horse-grid flex-grow-1 h-100">
                            <!-- Grid will be populated with numbers 1-20 -->
                        </div>
                    </div>
                    
                    <!-- Selected Results Display - RIGHT SIDE -->
                    <div class="col-12 col-lg-3 d-flex flex-column h-100">
                        <div class="results-display flex-grow-1 d-flex flex-column justify-content-center h-100">
                            <div class="result-box win-box mb-2">
                                <div class="result-label">ü•á WIN</div>
                                <div class="result-number" id="win-number">?</div>
                            </div>
                            <div class="result-box place-box mb-2">
                                <div class="result-label">ü•à PLACE</div>
                                <div class="result-number" id="place-number">?</div>
                            </div>
                            <div class="result-box show-box">
                                <div class="result-label">ü•â SHOW</div>
                                <div class="result-number" id="show-number">?</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex flex-column flex-sm-row">
                <button type="button" class="btn btn-secondary mb-2 mb-sm-0 me-sm-2" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning mb-2 mb-sm-0 me-sm-2" id="reset-selections-btn" onclick="resetSelections()">
                    üîÑ Reset Selections
                </button>
                <button type="button" class="btn btn-success btn-lg flex-sm-grow-1" id="finalize-results-btn" onclick="finalizeResults()" disabled>
                    üéâ Finalize Results
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/voice-prompt.js') }}"></script>
<script>
// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    checkVoiceSupport();
    loadSystemStatus();
    loadOpenAIUsage();
    
    // Set up OpenAI toggle
    document.getElementById('openaiToggle').addEventListener('change', toggleOpenAI);
    
    // Set up enter key for manual prompt
    document.getElementById('manualPrompt').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendManualPrompt();
        }
    });
    
    // Responsive adjustments
    handleResponsiveLayout();
});

// Handle responsive layout changes
function handleResponsiveLayout() {
    document.addEventListener('ddm:orientationchange', function(event) {
        // Adjust modal layouts when orientation changes
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (modal.classList.contains('show')) {
                // Trigger layout recalculation
                setTimeout(() => {
                    window.DDMResponsive.recalculateLayout();
                }, 100);
            }
        });
    });
}

// Check voice support
function checkVoiceSupport() {
    const statusElement = document.getElementById('voice-support-status');
    if (typeof voicePrompt !== 'undefined' && voicePrompt.isSupported()) {
        statusElement.textContent = '‚úÖ Voice recognition supported';
        statusElement.className = 'small text-success mt-2';
    } else {
        statusElement.textContent = '‚ùå Voice recognition not supported in this browser';
        statusElement.className = 'small text-warning mt-2';
    }
}

// Load system status
async function loadSystemStatus() {
    try {
        const response = await fetch('/api/openai/status');
        const data = await response.json();
        
        const statusElement = document.getElementById('openai-status');
        const textElement = document.getElementById('openai-text');
        
        if (data.configured) {
            statusElement.className = 'status-indicator status-online';
            textElement.textContent = 'Ready';
        } else {
            statusElement.className = 'status-indicator status-offline';
            textElement.textContent = 'Not configured';
        }
    } catch (error) {
        console.error('Error loading system status:', error);
    }
}

// Load OpenAI usage
async function loadOpenAIUsage() {
    try {
        const response = await fetch('/api/openai/usage');
        const data = await response.json();
        
        if (data.success) {
            const usage = data.usage;
            document.getElementById('hourly-usage').textContent = `${usage.hourly_usage}/${usage.hourly_limit}`;
            document.getElementById('daily-usage').textContent = `${usage.daily_usage}/${usage.daily_limit}`;
        }
    } catch (error) {
        console.error('Error loading usage:', error);
    }
}

// Toggle OpenAI
async function toggleOpenAI() {
    const enabled = document.getElementById('openaiToggle').checked;
    
    try {
        const response = await fetch('/api/openai/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({enabled: enabled})
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`OpenAI ${enabled ? 'enabled' : 'disabled'}`, 'success');
        } else {
            showNotification('Failed to toggle OpenAI', 'error');
        }
    } catch (error) {
        console.error('Error toggling OpenAI:', error);
        showNotification('Error toggling OpenAI', 'error');
    }
}

// Send manual prompt
async function sendManualPrompt() {
    const prompt = document.getElementById('manualPrompt').value.trim();
    
    if (!prompt) {
        showNotification('Please enter a prompt', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/openai/generate-led-sequence', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({description: prompt})
        });
        
        const data = await response.json();
        
        if (data.success) {
            addToHistory(prompt, data.sequence, 'manual');
            showNotification('Animation generated successfully!', 'success');
            document.getElementById('manualPrompt').value = '';
        } else {
            showNotification(data.error || 'Failed to generate animation', 'error');
        }
    } catch (error) {
        console.error('Error sending manual prompt:', error);
        showNotification('Network error', 'error');
    }
}

// Add to animation history
function addToHistory(prompt, sequence, source) {
    const historyContainer = document.getElementById('animation-history');
    
    // Remove "no animations" message
    if (historyContainer.textContent.includes('No animations')) {
        historyContainer.innerHTML = '';
    }
    
    const historyItem = document.createElement('div');
    historyItem.className = 'card mb-2';
    historyItem.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between">
                <div>
                    <strong>${source === 'voice' ? 'üé§' : '‚å®Ô∏è'} "${prompt}"</strong>
                    <small class="text-muted d-block">${new Date().toLocaleTimeString()}</small>
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="applyAnimation(this)">
                    Apply
                </button>
            </div>
            <pre class="small mt-2 mb-0">${JSON.stringify(sequence, null, 2)}</pre>
        </div>
    `;
    
    historyContainer.insertBefore(historyItem, historyContainer.firstChild);
    
    // Store sequence data
    historyItem.sequenceData = sequence;
}

// Apply animation
function applyAnimation(button) {
    const sequence = button.closest('.card').sequenceData;
    
    // Here you would send the sequence to your LED controller
    console.log('Applying animation:', sequence);
    showNotification('Animation applied to LEDs!', 'success');
}

// Utility functions
function showNotification(message, type = 'info') {
    const container = document.getElementById('notification-container');
    if (!container) return;
    
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'warning' ? 'alert-warning' :
                      type === 'success' ? 'alert-success' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    container.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

function refreshStatus() {
    loadSystemStatus();
    loadOpenAIUsage();
    showNotification('Status refreshed', 'success');
}

function testAnimation() {
    showNotification('Test animation would be sent to LEDs', 'info');
}

function clearLogs() {
    showNotification('Logs cleared', 'success');
}

// Voice prompt callbacks
window.onVoiceAnimationGenerated = function(data) {
    addToHistory(data.prompt, data.sequence, 'voice');
    loadOpenAIUsage(); // Refresh usage stats
};

window.onApplyVoiceAnimation = function(sequence) {
    // Here you would send the sequence to your LED controller
    console.log('Applying voice animation:', sequence);
};

// Mode modal functions
const MODE_CONFIG = {
    'pre_race': {
        title: 'Pre-Race Animations',
        icon: 'üèÅ',
        description: 'Setup and preparation animations'
    },
    'betting_open': {
        title: 'Betting Open Animations',
        icon: 'üí∞',
        description: 'Betting period animations'
    },
    'during_race': {
        title: 'During Race Animations',
        icon: 'üèá',
        description: 'Active race animations'
    },
    'results': {
        title: 'Results Animations',
        icon: 'üèÜ',
        description: 'Post-race celebration animations'
    }
};

async function openModeModal(mode) {
    try {
        // Special handling for results mode
        if (mode === 'results') {
            openHorseSelectionModal();
            return;
        }
        
        // Update modal title and icon
        const config = MODE_CONFIG[mode];
        document.getElementById('modal-mode-icon').textContent = config.icon;
        document.getElementById('modal-mode-title').textContent = config.title;
        
        // Update modal description based on mode
        const modalDescription = document.querySelector('.modal-body p');
        if (mode === 'during_race') {
            modalDescription.textContent = 'Live race control - tap animations as the race progresses:';
            modalDescription.className = 'text-success mb-4 fw-bold';
        } else {
            modalDescription.textContent = 'Select an animation to run for this mode:';
            modalDescription.className = 'text-muted mb-4';
        }
        
        // Show/hide End Race button based on mode
        const endRaceBtn = document.getElementById('modal-end-race-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');
        
        if (mode === 'during_race') {
            endRaceBtn.style.display = 'inline-block';
            cancelBtn.textContent = 'Minimize';
        } else {
            endRaceBtn.style.display = 'none';
            cancelBtn.textContent = 'Cancel';
        }
        
        // Fetch available animations for this mode
        const response = await fetch(`/api/display/mode-animations?mode=${mode}`);
        const data = await response.json();
        
        if (data.success) {
            populateAnimationButtons(data.animations, mode);
            
            // Show modal with special styling for during race
            const modalElement = document.getElementById('animationModal');
            if (mode === 'during_race') {
                modalElement.classList.add('during-race-modal');
            } else {
                modalElement.classList.remove('during-race-modal');
            }
            
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } else {
            showNotification(data.error || 'Failed to load animations', 'error');
        }
    } catch (error) {
        console.error('Error opening mode modal:', error);
        showNotification('Error loading animations', 'error');
    }
}

// Horse Selection Modal Logic
let selectionState = {
    step: 0, // 0=win, 1=place, 2=show
    selections: { win: null, place: null, show: null },
    stepLabels: ['SELECT WINNING HORSE', 'SELECT PLACE HORSE', 'SELECT SHOW HORSE']
};

function openHorseSelectionModal() {
    // Reset state
    selectionState = {
        step: 0,
        selections: { win: null, place: null, show: null },
        stepLabels: ['SELECT WINNING HORSE', 'SELECT PLACE HORSE', 'SELECT SHOW HORSE']
    };
    
    // Create horse grid
    createHorseGrid();
    updateSelectionStep();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('horseSelectionModal'));
    modal.show();
}

function createHorseGrid() {
    const gridContainer = document.querySelector('.horse-grid');
    gridContainer.innerHTML = '';
    
    // Create 20 horse number buttons
    for (let i = 1; i <= 20; i++) {
        const button = document.createElement('button');
        button.className = 'horse-number';
        button.textContent = i;
        button.onclick = () => selectHorse(i);
        gridContainer.appendChild(button);
    }
}

function selectHorse(number) {
    const stepKeys = ['win', 'place', 'show'];
    const currentStep = stepKeys[selectionState.step];
    
    // Don't allow selecting the same horse twice
    if (Object.values(selectionState.selections).includes(number)) {
        showNotification(`Horse #${number} already selected!`, 'warning');
        return;
    }
    
    // Record selection
    selectionState.selections[currentStep] = number;
    
    // Update display
    updateResultsDisplay();
    updateHorseGrid();
    
    // Move to next step or finish
    if (selectionState.step < 2) {
        selectionState.step++;
        updateSelectionStep();
    } else {
        // All selections made
        document.getElementById('finalize-results-btn').disabled = false;
        document.getElementById('selection-step').textContent = 'RESULTS COMPLETE - READY TO FINALIZE';
    }
}

function updateSelectionStep() {
    const stepLabel = document.getElementById('selection-step');
    stepLabel.textContent = selectionState.stepLabels[selectionState.step];
}

function updateResultsDisplay() {
    const winElement = document.getElementById('win-number');
    const placeElement = document.getElementById('place-number');
    const showElement = document.getElementById('show-number');
    
    // Get current step info - step hasn't been incremented yet when this is called
    const stepKeys = ['win', 'place', 'show'];
    const currentStep = stepKeys[selectionState.step];
    
    // Update all numbers without animation first
    winElement.textContent = selectionState.selections.win || '?';
    placeElement.textContent = selectionState.selections.place || '?';
    showElement.textContent = selectionState.selections.show || '?';
    
    // Only animate the current selection
    if (currentStep === 'win' && selectionState.selections.win) {
        winElement.classList.add('reveal');
        setTimeout(() => winElement.classList.remove('reveal'), 1500);
    } else if (currentStep === 'place' && selectionState.selections.place) {
        placeElement.classList.add('reveal');
        setTimeout(() => placeElement.classList.remove('reveal'), 1500);
    } else if (currentStep === 'show' && selectionState.selections.show) {
        showElement.classList.add('reveal');
        setTimeout(() => showElement.classList.remove('reveal'), 1500);
    }
    
    // Update box states
    const winBox = document.querySelector('.win-box');
    const placeBox = document.querySelector('.place-box');
    const showBox = document.querySelector('.show-box');
    
    // Update selected states without removing existing ones
    if (selectionState.selections.win && !winBox.classList.contains('selected')) {
        winBox.classList.add('selected');
    }
    if (selectionState.selections.place && !placeBox.classList.contains('selected')) {
        placeBox.classList.add('selected');
    }
    if (selectionState.selections.show && !showBox.classList.contains('selected')) {
        showBox.classList.add('selected');
    }
}

function updateHorseGrid() {
    const horseButtons = document.querySelectorAll('.horse-number');
    
    horseButtons.forEach(button => {
        const number = parseInt(button.textContent);
        
        // Remove all classes
        button.classList.remove('selected', 'disabled', 'win', 'place', 'show');
        
        // Mark selected horses with medal colors
        if (selectionState.selections.win === number) {
            button.classList.add('selected', 'win');
        } else if (selectionState.selections.place === number) {
            button.classList.add('selected', 'place');
        } else if (selectionState.selections.show === number) {
            button.classList.add('selected', 'show');
        }
        
        // Disable already selected horses for future selections
        if (selectionState.step < 2 && Object.values(selectionState.selections).includes(number)) {
            button.classList.add('disabled');
        }
    });
}

async function finalizeResults() {
    try {
        // Send results to backend
        const response = await fetch('/api/display/command', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                results: selectionState.selections
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`Results Finalized! Win: #${selectionState.selections.win}, Place: #${selectionState.selections.place}, Show: #${selectionState.selections.show}`, 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('horseSelectionModal'));
            modal.hide();
            
            // Update background with celebration
            updateBackgroundAnimation('race_results');
        } else {
            showNotification(data.error || 'Failed to finalize results', 'error');
        }
    } catch (error) {
        console.error('Error finalizing results:', error);
        showNotification('Error finalizing results', 'error');
    }
}

function populateAnimationButtons(animations, mode) {
    const buttonsContainer = document.getElementById('animation-buttons');
    buttonsContainer.innerHTML = '';
    
    // Special descriptions for during race animations
    const animationDescriptions = {
        'theyre_off': "üèÅ They're Off!\nBig green blast ‚Üí racing energy",
        'down_the_stretch': "üî• Down The Stretch!\nFinal stretch intensity",
        'finish_race': "üèÅ Finish Race!\nCheckered flag celebration"
    };
    
    animations.forEach(animation => {
        const button = document.createElement('button');
        button.className = 'btn btn-outline-primary animation-btn';
        
        // Use special descriptions for during race, otherwise format normally
        if (mode === 'during_race' && animationDescriptions[animation]) {
            button.innerHTML = animationDescriptions[animation].replace('\n', '<br>');
        } else {
            button.textContent = formatAnimationName(animation);
        }
        
        button.onclick = () => runAnimation(animation, mode);
        buttonsContainer.appendChild(button);
    });
}

function formatAnimationName(animation) {
    // Convert snake_case to Title Case
    return animation.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

async function runAnimation(animation, mode) {
    try {
        const response = await fetch('/api/display/command', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                animation: animation,
                mode: mode
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`Animation "${formatAnimationName(animation)}" started!`, 'success');
            updateBackgroundAnimation(animation);
        } else {
            showNotification(data.error || 'Failed to run animation', 'error');
        }
    } catch (error) {
        console.error('Error running animation:', error);
        showNotification('Error running animation', 'error');
    }
}

function updateBackgroundAnimation(animation) {
    const bgElement = document.getElementById('bg-animation');
    
    // Remove all animation classes
    bgElement.classList.remove('theyre-off', 'down-the-stretch', 'finish-race', 'race-results');
    
    // Add the appropriate animation class
    if (animation === 'theyre_off') {
        bgElement.classList.add('theyre-off');
    } else if (animation === 'down_the_stretch') {
        bgElement.classList.add('down-the-stretch');
    } else if (animation === 'finish_race') {
        bgElement.classList.add('finish-race');
    } else if (animation === 'race_results') {
        bgElement.classList.add('race-results');
    }
}

function endRace() {
    // Clear background animation
    const bgElement = document.getElementById('bg-animation');
    bgElement.classList.remove('theyre-off', 'down-the-stretch', 'finish-race', 'race-results');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('animationModal'));
    modal.hide();
    
    showNotification('Race ended', 'info');
}

function resetSelections() {
    selectionState = {
        step: 0,
        selections: { win: null, place: null, show: null },
        stepLabels: ['SELECT WINNING HORSE', 'SELECT PLACE HORSE', 'SELECT SHOW HORSE']
    };
    
    // Reset display
    document.getElementById('win-number').textContent = '?';
    document.getElementById('place-number').textContent = '?';
    document.getElementById('show-number').textContent = '?';
    
    // Reset boxes
    document.querySelectorAll('.result-box').forEach(box => {
        box.classList.remove('selected');
    });
    
    // Reset horse grid
    document.querySelectorAll('.horse-number').forEach(button => {
        button.classList.remove('selected', 'disabled', 'win', 'place', 'show');
    });
    
    // Reset step
    updateSelectionStep();
    document.getElementById('finalize-results-btn').disabled = true;
}
</script>
{% endblock %}
